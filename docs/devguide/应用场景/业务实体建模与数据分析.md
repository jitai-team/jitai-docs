---
sidebar_position: 2
---

# 业务实体建模与数据分析

某制造企业需要构建销售数据分析系统，管理客户、门店、销售员、产品、订单等业务实体。系统要求支持多数据库配置、客户信息中扩展常用统计字段、多维度分组分析，以及数据变更时的业务规则自动化处理。

通过JitORM的数据建模、扩展表、聚合表和模型事件能力，可以实现业务实体建模、数据扩展统计、多维度分析和业务规则自动化。

## 数据库配置

JitORM支持同时创建多个数据库实例元素，连接多种类型数据库服务，可以映射已有数据库表结构。

- **主业务数据库**：新业务数据存储，支持高并发操作
- **历史数据库**：历史数据保留，专门用于分析和报表
- **已有系统对接**：通过模型映射实现数据集成

**开发步骤**：
1. 创建主业务数据库：配置MySQL数据库实例"databases.MainDB"，用于新的业务数据存储
   
    ![创建主业务数据库](./img/jitorm/创建数据库元素.png)
   
2. 连接历史数据库（可选）：配置MySQL数据库实例"databases.HistoryDB"，连接历史数据分析库

## 业务实体建模与数据类型使用

系统包含客户、订单、订单明细、产品、门店、销售员等核心实体，通过关联关系构成完整的数据结构。

**实体关系设计**：客户/门店/销售员与订单为一对多关系，订单与订单明细为一对多关系，产品与订单明细为一对多关系。

**实体字段设计**：各实体包含基础信息字段、关联字段和状态字段，支持JitORM提供的丰富数据类型。

**开发步骤**：
1. 创建客户数据表模型：姓名(单行文本)、公司名称(单行文本)、详细描述(多行文本)、联系电话(手机号)、地址(地址)、身份证号(身份证号)、客户类型(选项组单选)、合作状态(检查框)
   
   ![创建数据表模型](./img/jitorm/创建数据表模型.png)

   ![配置模型字段](./img/jitorm/配置模型字段.png)

2. 创建门店数据表模型：门店名称(单行文本)、地址(地址)、联系方式(手机号)、门店分类(选项组单选)、营业状态(检查框)
3. 创建销售员数据表模型：员工姓名(单行文本)、工号(单行文本)、联系电话(手机号)、关联门店(关联数据单选)、在职状态(检查框)
4. 创建产品数据表模型：产品名称(单行文本)、产品分类(选项组单选)、价格(金额)、库存数量(数字)、产品图片(图片)、规格参数(富文本)、上架状态(检查框)
5. 创建订单数据表模型：订单编号(流水号)、销售金额(金额)、订单日期(日期时间)、支付状态(选项组单选)、关联客户(关联数据单选)、关联门店(关联数据单选)、关联销售员(关联数据单选)
6. 创建订单明细数据表模型：关联客户(关联数据单选)、关联订单(关联数据单选)、关联产品(关联数据单选)、购买数量(数字)、单价(金额)、小计金额(金额)

在创建模型时需要选择正确的数据库实例元素。

## 客户数据扩展与扩展表模型

通过扩展表模型，可以在不修改原有客户模型的前提下，关联订单数据并扩展出购买统计字段，避免频繁跳转查询。扩展表会自动生成LEFT JOIN查询，将统计数据作为扩展字段展示。

- **客户购买统计扩展**：以客户模型为基础，关联订单模型，扩展累计消费金额(求和)、购买次数(计数)两个统计字段
- **实时数据更新**：当订单数据发生变化时，扩展表中的统计字段会自动更新，保证客户统计信息的实时性

**开发步骤**：
1. 创建客户购买统计扩展表：以客户模型为基础模型
2. 添加关联关系：通过客户模型的主键ID字段与订单模型的关联客户字段建立关联，在添加关联关系时可以配置对订单模型的筛选条件，如支付状态为已付款等。
3. 配置扩展字段：对销售金额字段求和，作为新的"累计消费金额"字段；对订单记录计数，作为新的"购买次数"字段。

![配置扩展表](./img/jitorm/配置扩展表.png)

## 分组聚合统计与聚合表模型

通过聚合表模型的分组汇总、追加合并、横向连接功能，实现多维度数据分析。聚合表自动生成TQL来执行GROUP BY、UNION、JOIN等复杂SQL操作，支持多种条件组合筛选。

- **时间维度分析**：按年、季度、月、周分组，统计销售金额(SUM)、订单数量(COUNT)
- **地区维度分析**：利用地址字段的province、city解析功能，按地区分组统计销售业绩
- **产品分类维度分析**：基于产品分类字段分组，分析各品类销售表现和占比

**开发步骤**：
1. 创建时间维度聚合表：以订单模型为数据源，筛选已支付订单，基于订单日期字段按年、季度、月、周分组，配置销售金额(对销售金额求和)、订单数(对订单ID计数)聚合
2. 创建地区维度聚合表：以客户模型为数据源，利用地址字段的province、city解析功能分组，关联订单模型统计销售金额、订单数、客户数
3. 创建产品分类聚合表：以产品模型为数据源，基于产品分类字段分组，关联订单明细模型配置购买数量(SUM)、小计金额(SUM)聚合

![配置聚合表](./img/jitorm/配置聚合表.png)

## 业务规则自动化与模型事件

通过模型事件机制实现数据变更时的业务规则自动化处理，如库存更新、客户统计、外部同步等。

- **订单明细创建事件**：自动扣减产品库存数量，计算客户消费统计
- **数据更新事件**：支付状态变更时触发发货流程，客户信息变更时同步到外部CRM系统
- **字段变更事件**：客户类型发生变化时发送通知，销售金额修改时记录操作日志
- **数据审计**：记录敏感信息修改前的原始数据，用于审计追踪

**开发步骤**：
1. 配置库存扣减事件：监听订单模型AddAfter事件，筛选支付状态为已付款的订单，根据订单明细扣减产品库存数量
   ![配置模型事件](./img/jitorm/配置模型事件.png)
2. 设置客户统计事件：监听订单模型AddAfter事件，异步计算客户消费统计，根据销售金额阈值调整客户类型
3. 建立外部同步事件：监听客户模型UpdateAfter事件，筛选关键字段变更，异步调用外部CRM系统API同步信息
4. 实现审计日志事件：监听敏感模型的UpdateBefore事件，记录变更前数据用于审计追踪
